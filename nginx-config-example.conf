# ------------------------------------------------------------
# tesi.gexisun.com  反代：前端 -> 127.0.0.1:9174,  后端(API) -> 127.0.0.1:9000
# 注意：本配置假设后端路径为 /health 等（不带 /api 前缀）
# 如果你的后端确实是 /api/health，请把 /api/ 的 rewrite 去掉（看下面注释）
# ------------------------------------------------------------

# 80：强制跳转到 HTTPS
server {
  listen 80;
  server_name tesi.gexisun.com;
  return 301 https://$host$request_uri;
}

# 443：证书 + 分流
server {
  listen 443 ssl;
  server_name tesi.gexisun.com;

  ssl_certificate     /etc/letsencrypt/live/tesi.gexisun.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/tesi.gexisun.com/privkey.pem;

  # === API：/api/... -> 127.0.0.1:9000 ===
  location /api/ {
    # 如果后端路由是 /health（不带 /api），保留下面这一行以去掉前缀：
    rewrite ^/api/(.*)$ /$1 break;

    # 若后端本来就有 /api/health，请注释掉上面的 rewrite 行！
    proxy_pass http://127.0.0.1:9000;

    # 透传
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket / HMR
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_buffering off;

    # -------- CORS（统一由 Nginx 控制，覆盖后端错误的 A-C-A-*）--------
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;

    # 允许来自你的前端域名（如有其它域名，也请对应加站点或用 map 动态匹配）
    add_header Access-Control-Allow-Origin https://tesi.gexisun.com always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Allow-Methods GET,POST,PUT,PATCH,DELETE,OPTIONS always;
    add_header Access-Control-Allow-Headers Content-Type,Authorization,X-Requested-With,Accept,Origin,Referer,User-Agent always;

    # 处理预检
    if ($request_method = OPTIONS) {
      return 204;
    }
  }

  # === 前端：其余路径 -> 127.0.0.1:9174 ===
  location / {
    proxy_pass http://127.0.0.1:9174;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_buffering off;
  }
}
