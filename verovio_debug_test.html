<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verovio Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .results {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
            font-size: 12px;
        }
        .svg-container {
            border: 2px solid #dee2e6;
            border-radius: 5px;
            overflow: auto;
            max-height: 400px;
            margin: 20px 0;
        }
        .note, .rest {
            cursor: pointer !important;
        }
        .note:hover, .rest:hover {
            opacity: 0.7 !important;
            filter: drop-shadow(0 0 3px #007bff) !important;
        }
        .clicked-element {
            filter: drop-shadow(0 0 5px #dc3545) !important;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
    <script src="https://www.verovio.org/javascript/develop/verovio-toolkit-wasm.js"></script>
</head>
<body>
    <div class="container">
        <h1>Verovio Detailed Debug Test</h1>
        
        <div class="controls">
            <button onclick="loadSampleMusicXML()">Load Sample MusicXML</button>
            <button onclick="debugToolkit()">Debug Toolkit</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div id="debug-results" class="results">Debug information will appear here</div>

        <div class="svg-container" id="svg-container">
            <p style="padding: 20px; text-align: center; color: #6c757d;">MusicXML will be rendered here</p>
        </div>
    </div>

    <script>
        let verovio = null;
        let currentMEI = '';

        // 初始化 Verovio
        async function initializeVerovio() {
            try {
                console.log('Initializing Verovio...');
                
                let attempts = 0;
                while (attempts < 50) {
                    if (typeof verovio_module !== 'undefined') {
                        console.log('Found verovio_module, initializing...');
                        verovio = new verovio_module.toolkit();
                        break;
                    } else if (typeof window.verovio !== 'undefined' && window.verovio.toolkit) {
                        console.log('Found window.verovio, initializing...');
                        verovio = new window.verovio.toolkit();
                        break;
                    } else if (typeof Module !== 'undefined' && Module.VerovioToolkit) {
                        console.log('Found Module.VerovioToolkit, initializing...');
                        verovio = new Module.VerovioToolkit();
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!verovio) {
                    throw new Error('Verovio module not found');
                }
                
                // 设置选项
                verovio.setOptions({
                    adjustPageHeight: true,
                    pageHeight: 2970,
                    pageWidth: 2100,
                    scale: 40,
                    font: 'Leipzig',
                    header: 'none',
                    footer: 'none',
                    breaks: 'auto',
                    xmlIdSeed: 1,
                    removeIds: false,
                    svgViewBox: true,
                });
                
                console.log('Verovio initialized successfully');
                return true;
            } catch (error) {
                console.error('Failed to initialize Verovio:', error);
                return false;
            }
        }

        async function debugToolkit() {
            if (!verovio) {
                await initializeVerovio();
            }

            let debug = 'Verovio Toolkit Debug Information:\n\n';
            
            try {
                debug += `Version: ${verovio.getVersion()}\n\n`;
            } catch (e) {
                debug += `Version: Error - ${e.message}\n\n`;
            }

            // 列出所有可用的方法
            debug += 'Available methods on toolkit:\n';
            const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(verovio));
            methods.sort().forEach(method => {
                if (typeof verovio[method] === 'function') {
                    debug += `  ✓ ${method}\n`;
                }
            });
            
            debug += '\nDirect properties:\n';
            Object.keys(verovio).forEach(key => {
                debug += `  ${key}: ${typeof verovio[key]}\n`;
            });

            document.getElementById('debug-results').textContent = debug;
        }

        async function loadSampleMusicXML() {
            if (!verovio) {
                const initialized = await initializeVerovio();
                if (!initialized) return;
            }

            const sampleMusicXML = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <part-list>
    <score-part id="P1">
      <part-name>Piano</part-name>
    </score-part>
  </part-list>
  <part id="P1">
    <measure number="1">
      <attributes>
        <divisions>4</divisions>
        <key>
          <fifths>0</fifths>
        </key>
        <time>
          <beats>4</beats>
          <beat-type>4</beat-type>
        </time>
        <clef>
          <sign>G</sign>
          <line>2</line>
        </clef>
      </attributes>
      <note>
        <pitch>
          <step>C</step>
          <octave>4</octave>
        </pitch>
        <duration>4</duration>
        <type>quarter</type>
      </note>
      <note>
        <pitch>
          <step>D</step>
          <octave>4</octave>
        </pitch>
        <duration>4</duration>
        <type>quarter</type>
      </note>
      <note>
        <pitch>
          <step>E</step>
          <octave>4</octave>
        </pitch>
        <duration>4</duration>
        <type>quarter</type>
      </note>
      <note>
        <pitch>
          <step>F</step>
          <octave>4</octave>
        </pitch>
        <duration>4</duration>
        <type>quarter</type>
      </note>
    </measure>
    <measure number="2">
      <note>
        <pitch>
          <step>G</step>
          <octave>4</octave>
        </pitch>
        <duration>8</duration>
        <type>half</type>
      </note>
      <note>
        <pitch>
          <step>A</step>
          <octave>4</octave>
        </pitch>
        <duration>8</duration>
        <type>half</type>
      </note>
    </measure>
  </part>
</score-partwise>`;

            try {
                console.log('Loading sample MusicXML...');
                
                const success = verovio.loadData(sampleMusicXML);
                if (!success) {
                    throw new Error('Failed to parse MusicXML data');
                }
                
                const svg = verovio.renderToSVG(1);
                document.getElementById('svg-container').innerHTML = svg;
                
                // 获取 MEI 数据并详细分析
                try {
                    currentMEI = verovio.getMEI();
                    analyzeMEI();
                } catch (meiError) {
                    console.error('Failed to get MEI:', meiError);
                }
                
                addClickListeners();
                console.log('Sample loaded successfully');
                
            } catch (error) {
                console.error('Error loading sample:', error);
                document.getElementById('svg-container').innerHTML = 
                    `<p style="color: red; padding: 20px;">Error: ${error.message}</p>`;
            }
        }

        function analyzeMEI() {
            let analysis = 'MEI Analysis:\n\n';
            
            if (!currentMEI) {
                analysis += 'No MEI data available\n';
                document.getElementById('debug-results').textContent = analysis;
                return;
            }

            analysis += `MEI data length: ${currentMEI.length} characters\n\n`;
            
            // 解析 MEI
            const parser = new DOMParser();
            const meiDoc = parser.parseFromString(currentMEI, 'text/xml');
            
            // 检查解析错误
            const parseErrors = meiDoc.getElementsByTagName('parsererror');
            if (parseErrors.length > 0) {
                analysis += `Parsing errors: ${parseErrors[0].textContent}\n\n`;
            }

            // 分析结构
            const rootElement = meiDoc.documentElement;
            analysis += `Root element: ${rootElement.tagName}\n`;
            analysis += `Root namespace: ${rootElement.namespaceURI}\n\n`;

            // 查找所有音符元素
            const notes = meiDoc.querySelectorAll('note');
            analysis += `Found ${notes.length} note elements:\n`;
            
            for (let i = 0; i < Math.min(10, notes.length); i++) {
                const note = notes[i];
                const id = note.getAttribute('xml:id') || note.getAttribute('id');
                const pname = note.getAttribute('pname');
                const oct = note.getAttribute('oct');
                const dur = note.getAttribute('dur');
                const tstamp = note.getAttribute('tstamp');
                
                analysis += `  Note ${i+1}: id=${id}, pname=${pname}, oct=${oct}, dur=${dur}, tstamp=${tstamp}\n`;
                
                // 查找父级元素
                const measure = note.closest('measure');
                const layer = note.closest('layer');
                const staff = note.closest('staff');
                
                if (measure) {
                    analysis += `    Measure: n=${measure.getAttribute('n')}\n`;
                }
                if (layer) {
                    analysis += `    Layer: n=${layer.getAttribute('n')}\n`;
                }
                if (staff) {
                    analysis += `    Staff: n=${staff.getAttribute('n')}\n`;
                }
                analysis += '\n';
            }

            // 查找所有 measure 元素
            const measures = meiDoc.querySelectorAll('measure');
            analysis += `\nFound ${measures.length} measure elements:\n`;
            for (let i = 0; i < measures.length; i++) {
                const measure = measures[i];
                analysis += `  Measure ${i+1}: n=${measure.getAttribute('n')}\n`;
            }

            document.getElementById('debug-results').textContent = analysis;
        }

        function addClickListeners() {
            const clickableElements = document.querySelectorAll('.note, .rest');
            
            clickableElements.forEach(element => {
                element.style.cursor = 'pointer';
                element.addEventListener('click', (event) => {
                    event.stopPropagation();
                    handleElementClick(element);
                });
            });
        }

        function handleElementClick(element) {
            // 清除之前的高亮
            document.querySelectorAll('.clicked-element').forEach(el => {
                el.classList.remove('clicked-element');
            });
            element.classList.add('clicked-element');
            
            const svg_id = element.getAttribute('id') || '';
            debugElement(svg_id, element);
        }

        function debugElement(svg_id, element) {
            let debug = `Detailed Element Debug for ID: ${svg_id}\n\n`;
            
            debug += `SVG Element Information:\n`;
            debug += `  Tag: ${element.tagName}\n`;
            debug += `  Class: ${element.getAttribute('class') || 'N/A'}\n`;
            debug += `  All attributes:\n`;
            for (let attr of element.attributes) {
                debug += `    ${attr.name}: ${attr.value}\n`;
            }
            debug += '\n';

            // 遍历父元素
            debug += `Parent Element Chain:\n`;
            let parent = element.parentElement;
            let level = 1;
            while (parent && parent.tagName !== 'svg' && level <= 10) {
                const id = parent.getAttribute('id') || '';
                const className = parent.getAttribute('class') || '';
                debug += `  Level ${level}: ${parent.tagName} id="${id}" class="${className}"\n`;
                parent = parent.parentElement;
                level++;
            }
            debug += '\n';

            if (verovio && svg_id) {
                // 测试各种 Verovio 方法
                debug += `Verovio API Tests:\n`;
                
                // getTimeForElement
                try {
                    const time = verovio.getTimeForElement(svg_id);
                    debug += `  getTimeForElement: ${time}\n`;
                } catch (e) {
                    debug += `  getTimeForElement: ERROR - ${e.message}\n`;
                }

                // getTimesForElement
                try {
                    const times = verovio.getTimesForElement(svg_id);
                    debug += `  getTimesForElement: ${JSON.stringify(times)}\n`;
                } catch (e) {
                    debug += `  getTimesForElement: ERROR - ${e.message}\n`;
                }

                // getPageWithElement
                try {
                    const page = verovio.getPageWithElement(svg_id);
                    debug += `  getPageWithElement: ${page}\n`;
                } catch (e) {
                    debug += `  getPageWithElement: ERROR - ${e.message}\n`;
                }

                // getElementAttr 测试
                debug += `  getElementAttr tests:\n`;
                const attrs = ['xml:id', 'tstamp', 'pname', 'oct', 'dur'];
                attrs.forEach(attr => {
                    try {
                        const value = verovio.getElementAttr(svg_id, attr);
                        debug += `    ${attr}: ${JSON.stringify(value)}\n`;
                    } catch (e) {
                        debug += `    ${attr}: ERROR - ${e.message}\n`;
                    }
                });
                debug += '\n';
            }

            // MEI 解析
            debug += `MEI Element Search:\n`;
            if (currentMEI) {
                const parser = new DOMParser();
                const meiDoc = parser.parseFromString(currentMEI, 'text/xml');
                
                // 尝试多种搜索方式
                const searchMethods = [
                    { name: '[xml:id]', selector: `[xml\\:id="${svg_id}"]` },
                    { name: '[*|id]', selector: `[*|id="${svg_id}"]` },
                    { name: '[id]', selector: `[id="${svg_id}"]` },
                    { name: 'getElementById', method: 'getElementById' }
                ];
                
                let found = false;
                for (const method of searchMethods) {
                    try {
                        let meiElement;
                        if (method.method === 'getElementById') {
                            meiElement = meiDoc.getElementById(svg_id);
                        } else {
                            meiElement = meiDoc.querySelector(method.selector);
                        }
                        
                        debug += `  ${method.name}: ${meiElement ? 'FOUND' : 'Not found'}\n`;
                        
                        if (meiElement && !found) {
                            found = true;
                            debug += `    Element: ${meiElement.tagName}\n`;
                            debug += `    Attributes:\n`;
                            for (let attr of meiElement.attributes) {
                                debug += `      ${attr.name}: ${attr.value}\n`;
                            }
                            
                            // 查找父级信息
                            const measure = meiElement.closest('measure');
                            const layer = meiElement.closest('layer');
                            const staff = meiElement.closest('staff');
                            
                            if (measure) {
                                debug += `    Measure: n=${measure.getAttribute('n')}\n`;
                            }
                            if (layer) {
                                debug += `    Layer: n=${layer.getAttribute('n')}\n`;
                            }
                            if (staff) {
                                debug += `    Staff: n=${staff.getAttribute('n')}\n`;
                            }
                        }
                    } catch (e) {
                        debug += `  ${method.name}: ERROR - ${e.message}\n`;
                    }
                }
                
                if (!found) {
                    debug += `  Element not found in MEI. Listing all note IDs:\n`;
                    const allNotes = meiDoc.querySelectorAll('note');
                    for (let i = 0; i < Math.min(10, allNotes.length); i++) {
                        const note = allNotes[i];
                        const id = note.getAttribute('xml:id') || note.getAttribute('id');
                        debug += `    Note ${i+1}: ${id}\n`;
                    }
                }
            } else {
                debug += `  No MEI data available\n`;
            }

            document.getElementById('debug-results').textContent = debug;
        }

        function clearResults() {
            document.getElementById('debug-results').textContent = 'Debug information will appear here';
            document.querySelectorAll('.clicked-element').forEach(el => {
                el.classList.remove('clicked-element');
            });
        }

        // 页面加载时初始化
        window.addEventListener('load', async () => {
            console.log('Page loaded, waiting for Verovio...');
            setTimeout(async () => {
                await initializeVerovio();
                await debugToolkit();
            }, 2000);
        });
    </script>
</body>
</html>
